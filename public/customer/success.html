<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>Order Successful - Slice N Grind</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: #f8f9fa;
      }
      .container {
        margin-top: 50px;
        text-align: center;
      }
      .payment-status {
        max-width: 600px;
        margin: 20px auto;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="card">
        <div class="card-header bg-success text-white">
          <h3><i class="fas fa-check-circle"></i> Order Successful</h3>
        </div>
        <div class="card-body">
          <p class="lead">Thank you for your order!</p>
          <p>
            Your order has been successfully placed. You will receive a
            confirmation soon.
          </p>
          <a href="/customer/menu.html" class="btn btn-primary">
            <i class="fas fa-shopping-cart"></i> Continue Shopping
          </a>
          <a href="/customer/profile.html" class="btn btn-outline-secondary">
            <i class="fas fa-user"></i> View Profile
          </a>
        </div>
      </div>
      <div id="paymentStatus" class="payment-status"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        // Clear cart
        try {
          const token = sessionStorage.getItem("token");
          if (token) {
            const response = await fetch("/api/cart/clear", {
              method: "POST",
              headers: {
                Authorization: `Bearer ${token}`,
              },
            });
            console.log(response.ok ? "Cart cleared" : "Cart already empty");
          }
        } catch (error) {
          console.error("Cart clearance error:", error);
        }

        // Check payment status for GCash orders
        const urlParams = new URLSearchParams(window.location.search);
        const orderId = urlParams.get("orderId");
        const paymentData = JSON.parse(
          sessionStorage.getItem("currentPayment") || "{}"
        );

        if (paymentData.paymentId && paymentData.orderId === orderId) {
          try {
            const response = await fetch(
              `/api/payment/verify-payment/${paymentData.paymentId}`
            );
            const result = await response.json();

            if (!result.isPaid) {
              document.getElementById("paymentStatus").innerHTML = `
              <div class="alert alert-warning">
                <i class="fas fa-clock"></i> Waiting for payment confirmation...
                <button onclick="location.reload()" class="btn btn-sm btn-primary ms-2">
                  <i class="fas fa-sync-alt"></i> Refresh
                </button>
              </div>
            `;
            }
            sessionStorage.removeItem("currentPayment");
          } catch (error) {
            console.error("Payment verification failed:", error);
          }
        }
      });
    </script>
  </body>
</html>

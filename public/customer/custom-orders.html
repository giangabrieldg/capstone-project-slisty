<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Custom Cake Orders - Slice N Grind</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=Baloo+2:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/styles/navbar.css" />
    <link rel="stylesheet" href="/styles/footer.css" />
    <link rel="stylesheet" href="/styles/my-custom-orders.css" />
  </head>
  <body>
    <!-- Navbar -->
    <div data-include-html="/includes/navbar.html"></div>

    <!-- Main Content -->
    <div class="container-main">
      <h2 class="page-title">My Custom Cake Orders</h2>

      <div class="table-container">
        <div class="table-responsive">
          <table class="table table-hover">
            <div class="d-flex justify-content-between mb-3">
              <h5>Total Orders: <span id="orderCount">0</span></h5>
            </div>
            <thead>
              <tr>
                <th>Order ID</th>
                <th>Type</th>
                <th>Details</th>
                <th>Delivery Date</th>
                <th>Status</th>
                <th>Image</th>
                <th>Price</th>
                <th>Payment</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="ordersTableBody">
              <!-- Orders will be populated dynamically -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Image Modal -->
    <div
      class="modal fade"
      id="imageModal"
      tabindex="-1"
      aria-labelledby="imageModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="imageModalLabel">Custom Cake Image</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <img
              src=""
              class="modal-img"
              id="modalImage"
              alt="Custom Cake Image"
            />
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div data-include-html="/includes/footer.html"></div>

    <script src="/scripts/include-html.js"></script>
    <script src="/scripts/update-navbar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/scripts/custom-cake.js"></script>
    <script>
      // Enhanced customer orders script with downpayment UI indicators
      const apiService = new CakeAPIService();

      async function fetchCustomOrders() {
        try {
          const response = await apiService.getCustomOrders();
          if (response.success) {
            populateOrdersTable(
              response.data.customOrders,
              response.data.imageOrders
            );
            document.getElementById("orderCount").textContent =
              response.data.customOrders.length +
              response.data.imageOrders.length;
          } else {
            alert(
              response.message || "Failed to load orders. Please try again."
            );
          }
        } catch (error) {
          console.error("Error fetching orders:", error);
          alert("Failed to load orders. Please try again.");
        }
      }

      function populateOrdersTable(customOrders, imageOrders) {
        const tableBody = document.getElementById("ordersTableBody");
        tableBody.innerHTML = "";

        console.log("Displaying orders:", {
          customOrders: customOrders.length,
          imageOrders: imageOrders.length,
        });

        // Custom Cake Orders (3D)
        customOrders.forEach((order) => {
          const displayOrderId = `CC${String(order.customCakeId).padStart(
            3,
            "0"
          )}`;
          const statusClass = getStatusClass(order.status, false);
          const flavor = getFlavorName(order.cakeColor);
          const details = `Size: ${order.size}, Flavor: ${flavor}, Icing: ${order.icingStyle}`;
          const imageUrl =
            order.designImageUrl || order.referenceImageUrl || "";
          const deliveryDate = order.deliveryDate
            ? new Date(order.deliveryDate).toLocaleDateString()
            : "Not set";

          const row = document.createElement("tr");
          row.innerHTML = `
      <td><span class="order-id">${displayOrderId}</span></td>
      <td><span class="order-type-badge order-type-3d">3D Custom Cake</span></td>
      <td><div class="order-details">${details}</div></td>
      <td><span class="delivery-date">${deliveryDate}</span></td>
      <td>${renderStatusBadge(order.status, false)}</td>
      <td>
        ${
          imageUrl
            ? `<button class="btn btn-view-image" onclick="viewImage('${imageUrl}')">View Image</button>`
            : '<span class="no-image-text">No Image</span>'
        }
      </td>
      <td>${renderPriceDisplay(order)}</td>
      <td>${renderPaymentDisplay(order)}</td>
      <td>${renderActionButtons(order, false)}</td>
    `;
          tableBody.appendChild(row);
        });

        // Image-Based Orders
        imageOrders.forEach((order) => {
          const displayOrderId = `RCC${String(order.imageBasedOrderId).padStart(
            3,
            "0"
          )}`;
          const statusClass = getStatusClass(order.status, true);
          const details = `Flavor: ${order.flavor}, Size: ${
            order.size || "Not specified"
          }, Event: ${new Date(order.eventDate).toLocaleDateString()}`;
          const deliveryDate = order.deliveryDate
            ? new Date(order.deliveryDate).toLocaleDateString()
            : "Not set";

          const row = document.createElement("tr");
          row.innerHTML = `
      <td><span class="order-id">${displayOrderId}</span></td>
      <td><span class="order-type-badge order-type-image">Image-Based Cake</span></td>
      <td><div class="order-details">${details}</div></td>
      <td><span class="delivery-date">${deliveryDate}</span></td>
      <td>${renderStatusBadge(order.status, true)}</td>
      <td>
        ${
          order.imagePath
            ? `<button class="btn btn-view-image" onclick="viewImage('${order.imagePath}')">View Image</button>`
            : '<span class="no-image-text">No Image</span>'
        }
      </td>
      <td>${renderPriceDisplay(order)}</td>
      <td>${renderPaymentDisplay(order)}</td>
      <td>${renderActionButtons(order, true)}</td>
    `;
          tableBody.appendChild(row);
        });

        // Show empty state if no orders
        if (customOrders.length === 0 && imageOrders.length === 0) {
          const row = document.createElement("tr");
          row.innerHTML = `
      <td colspan="9" class="text-center py-4">
        <div class="empty-state">
          <div class="icon">ðŸŽ‚</div>
          <h4>No Custom Orders Yet</h4>
          <p>Start by creating a custom cake order!</p>
        </div>
      </td>
    `;
          tableBody.appendChild(row);
        }
      }

      // Enhanced status badge rendering
      function renderStatusBadge(status, isImageOrder) {
        const statusConfig = {
          "Pending Review": {
            class: "status-pending",
            icon: "fa-clock",
            text: "Pending Review",
          },
          "Ready for Downpayment": {
            class: "status-ready-payment",
            icon: "fa-dollar-sign",
            text: "Ready for Downpayment",
          },
          "Downpayment Paid": {
            class: "status-downpayment-paid",
            icon: "fa-check-circle",
            text: "Downpayment Paid",
          },
          "In Progress": {
            class: "status-in-progress",
            icon: "fa-cog",
            text: "In Progress",
          },
          "Ready for Pickup/Delivery": {
            class: "status-ready",
            icon: "fa-box",
            text: "Ready",
          },
          Completed: {
            class: "status-completed",
            icon: "fa-check-double",
            text: "Completed",
          },
          Cancelled: {
            class: "status-cancelled",
            icon: "fa-times-circle",
            text: "Cancelled",
          },
          Feasible: {
            class: "status-feasible",
            icon: "fa-thumbs-up",
            text: "Feasible",
          },
          "Not Feasible": {
            class: "status-not-feasible",
            icon: "fa-thumbs-down",
            text: "Not Feasible",
          },
        };

        const config = statusConfig[status] || {
          class: "status-pending",
          icon: "fa-question",
          text: status,
        };
        return `<span class="${config.class}"><i class="fas ${config.icon}"></i> ${config.text}</span>`;
      }

      // Fixed renderPriceDisplay with proper null/undefined checks
      function renderPriceDisplay(order) {
        if (!order.price) {
          return '<span class="price-tbd">TBD</span>';
        }

        let html = `<div class="price-container">`;
        html += `<div class="total-price">â‚±${parseFloat(order.price).toFixed(
          2
        )}</div>`;

        // FIXED: Add null/undefined checks before calling toFixed()
        const hasDownpaymentData =
          order.downpayment_amount !== null &&
          order.downpayment_amount !== undefined &&
          order.remaining_balance !== null &&
          order.remaining_balance !== undefined;

        if (hasDownpaymentData) {
          const downpaymentAmount = parseFloat(order.downpayment_amount) || 0;
          const remainingBalance = parseFloat(order.remaining_balance) || 0;

          html += `
      <div class="price-breakdown">
        <small class="text-muted">
          <div><i class="fas fa-info-circle"></i> Breakdown:</div>
          <div>50% Down: â‚±${downpaymentAmount.toFixed(2)}</div>
          <div>Balance: â‚±${remainingBalance.toFixed(2)}</div>
        </small>
      </div>`;
        }

        html += `</div>`;
        return html;
      }

      // Fixed renderPaymentDisplay with proper null checks
      function renderPaymentDisplay(order) {
        let html = `<div class="payment-display">`;

        // Payment method
        const paymentMethod =
          order.payment_status === "paid"
            ? "GCash"
            : order.payment_status === "pending"
            ? "Cash"
            : "Not set";

        html += `<div class="payment-method mb-2">
    <span class="badge ${
      order.payment_status === "paid" ? "bg-success" : "bg-warning text-dark"
    }">
      ${paymentMethod}
    </span>
  </div>`;

        // Downpayment progress - FIXED with null checks
        if (order.is_downpayment_paid === true) {
          const finalPaid = order.final_payment_status === "paid";
          const downpaymentAmount = parseFloat(order.downpayment_amount) || 0;
          const remainingBalance = parseFloat(order.remaining_balance) || 0;

          html += `
      <div class="payment-progress mb-2">
        <div class="progress-step completed">
          <i class="fas fa-check-circle"></i>
          <small>Downpayment</small>
          <div class="amount">â‚±${downpaymentAmount.toFixed(2)}</div>
        </div>
        <div class="progress-arrow">â†’</div>
        <div class="progress-step ${finalPaid ? "completed" : "pending"}">
          <i class="fas ${finalPaid ? "fa-check-circle" : "fa-clock"}"></i>
          <small>Final Payment</small>
          <div class="amount">â‚±${remainingBalance.toFixed(2)}</div>
        </div>
      </div>`;

          html += finalPaid
            ? '<span class="badge bg-success w-100"><i class="fas fa-check-double"></i> Fully Paid</span>'
            : '<span class="badge bg-warning text-dark w-100"><i class="fas fa-hourglass-half"></i> Balance Due</span>';
        } else {
          // No downpayment yet
          html +=
            order.payment_status === "paid"
              ? '<span class="badge bg-success"><i class="fas fa-check"></i> Paid</span>'
              : '<span class="badge bg-secondary"><i class="fas fa-clock"></i> Awaiting Payment</span>';
        }

        html += `</div>`;
        return html;
      }

      // Fixed renderActionButtons with proper null checks
      function renderActionButtons(order, isImageOrder) {
        const orderId = isImageOrder
          ? order.imageBasedOrderId
          : order.customCakeId;

        if (isImageOrder) {
          // Image-based order actions
          if (order.status === "Not Feasible" || order.status === "Cancelled") {
            return `<span class="text-muted">${order.status}</span>`;
          }

          // In renderActionButtons function, UPDATE the downpayment button section:
          if (
            (order.status === "Feasible" ||
              order.status === "Ready for Downpayment") &&
            order.price &&
            order.is_downpayment_paid !== true
          ) {
            // Ready for downpayment - show GCash requirement
            const downpaymentAmount =
              order.downpayment_amount || order.price * 0.5;
            return `
    <div class="downpayment-container">
      <button class="btn btn-checkout btn-downpayment" onclick="checkoutOrder(${orderId}, ${isImageOrder})">
        <i class="fas fa-mobile-alt"></i> Pay 50% Downpayment via GCash
        <small class="d-block">(â‚±${parseFloat(downpaymentAmount).toFixed(
          2
        )})</small>
      </button>
      <small class="text-muted d-block mt-1">
        <i class="fas fa-info-circle"></i> GCash required for downpayment
      </small>
    </div>`;
          }

          if (
            order.is_downpayment_paid === true &&
            order.final_payment_status !== "paid"
          ) {
            // Downpayment paid, show balance due
            const remainingBalance = parseFloat(order.remaining_balance) || 0;
            return `
        <div class="balance-due-container">
          <span class="badge bg-info mb-2 w-100">
            <i class="fas fa-check-circle"></i> Downpayment Paid
          </span>
          <div class="balance-info">
            <small class="text-muted">Balance Due:</small>
            <div class="fw-bold">â‚±${remainingBalance.toFixed(2)}</div>
            <small class="text-muted">Pay upon pickup/delivery</small>
          </div>
        </div>`;
          }

          if (order.final_payment_status === "paid") {
            return `<span class="badge bg-success"><i class="fas fa-check-double"></i> Fully Paid</span>`;
          }

          if (
            order.payment_status === "pending" &&
            [
              "Pending",
              "In Progress",
              "Ready for Pickup/Delivery",
              "Completed",
            ].includes(order.status)
          ) {
            return `<span class="badge bg-warning">Cash - Balance Due</span>`;
          }

          return `<span class="text-info">${order.status}</span>`;
        } else {
          // 3D custom cake actions
          if (order.status === "Cancelled") {
            return `<span class="text-muted">Cancelled</span>`;
          }

          if (
            order.status === "Ready for Downpayment" &&
            order.price &&
            order.is_downpayment_paid !== true
          ) {
            // Ready for downpayment
            const downpaymentAmount =
              order.downpayment_amount || order.price * 0.5;
            return `
        <button class="btn btn-checkout btn-downpayment" onclick="checkoutOrder(${orderId}, false)">
          <i class="fas fa-dollar-sign"></i> Pay 50% Downpayment
          <small class="d-block">(â‚±${parseFloat(downpaymentAmount).toFixed(
            2
          )})</small>
        </button>`;
          }

          if (
            order.is_downpayment_paid === true &&
            order.final_payment_status !== "paid"
          ) {
            // Downpayment paid, show balance due
            const remainingBalance = parseFloat(order.remaining_balance) || 0;
            return `
        <div class="balance-due-container">
          <span class="badge bg-info mb-2 w-100">
            <i class="fas fa-check-circle"></i> Downpayment Paid
          </span>
          <div class="balance-info">
            <small class="text-muted">Balance Due:</small>
            <div class="fw-bold">â‚±${remainingBalance.toFixed(2)}</div>
            <small class="text-muted">Pay upon pickup/delivery</small>
          </div>
        </div>`;
          }

          if (order.final_payment_status === "paid") {
            return `<span class="badge bg-success"><i class="fas fa-check-double"></i> Fully Paid</span>`;
          }

          if (
            order.payment_status === "pending" &&
            [
              "Pending",
              "In Progress",
              "Ready for Pickup/Delivery",
              "Completed",
            ].includes(order.status)
          ) {
            return `<span class="badge bg-warning">Cash - Balance Due</span>`;
          }

          return `<span class="text-info">${order.status}</span>`;
        }
      }

      // Helper function to get flavor name
      function getFlavorName(cakeColor) {
        const flavors = {
          "#8B4513": "Chocolate",
          "#FFFFFF": "White",
          "#FFD700": "Vanilla",
          "#FF69B4": "Strawberry",
        };
        return flavors[cakeColor] || "Custom";
      }

      // Get status class based on status type
      function getStatusClass(status, isImageOrder) {
        if (isImageOrder) {
          switch (status) {
            case "Feasible":
            case "Ready for Downpayment":
              return "status-feasible";
            case "Downpayment Paid":
            case "In Progress":
            case "Ready for Pickup/Delivery":
            case "Completed":
              return "status-completed";
            case "Not Feasible":
            case "Cancelled":
              return "status-not-feasible";
            default:
              return "status-pending";
          }
        } else {
          switch (status) {
            case "Ready for Downpayment":
            case "In Progress":
              return "status-feasible";
            case "Downpayment Paid":
            case "Ready for Pickup/Delivery":
            case "Completed":
              return "status-completed";
            case "Cancelled":
              return "status-not-feasible";
            default:
              return "status-pending";
          }
        }
      }

      async function checkoutOrder(orderId, isImageOrder) {
        try {
          const orderDetails = await apiService.getOrderDetails(
            orderId,
            isImageOrder
          );
          if (!orderDetails.success) {
            throw new Error("Could not retrieve order details");
          }

          const order = orderDetails.data.order;

          console.log("Checkout order details:", order);

          // Determine payment amount and type based on status
          let paymentAmount, isDownpayment;

          // FIXED: Handle different statuses for image-based vs 3D cakes
          const validDownpaymentStatuses = isImageOrder
            ? ["Feasible", "Ready for Downpayment"]
            : ["Ready for Downpayment"];

          if (order.is_downpayment_paid === true) {
            // Downpayment already paid
            alert(
              "Downpayment already paid. The remaining balance will be collected upon pickup/delivery."
            );
            return;
          } else if (validDownpaymentStatuses.includes(order.status)) {
            // First payment - downpayment
            paymentAmount = order.downpayment_amount || order.price * 0.5;
            isDownpayment = true;

            console.log("Proceeding to downpayment checkout:", {
              orderId,
              isImageOrder,
              paymentAmount,
              isDownpayment,
            });
          } else {
            // Order not ready for payment
            alert(
              `This order is not ready for payment. Current status: ${order.status}`
            );
            return;
          }

          // Redirect to checkout with proper parameters
          const checkoutUrl = `/customer/checkout.html?customCakeId=${orderId}&isImageOrder=${isImageOrder}&amount=${paymentAmount}&isDownpayment=${isDownpayment}`;

          console.log("Redirecting to:", checkoutUrl);
          window.location.href = checkoutUrl;
        } catch (error) {
          console.error("Error during checkout:", error);
          alert("Failed to proceed to checkout. Please try again.");
        }
      }

      // View image in modal
      function viewImage(imageUrl) {
        const modalImage = document.getElementById("modalImage");
        modalImage.src = imageUrl;
        const modal = new bootstrap.Modal(
          document.getElementById("imageModal")
        );
        modal.show();
      }

      // Load ALL orders on page load
      document.addEventListener("DOMContentLoaded", fetchCustomOrders);
    </script>
  </body>
</html>

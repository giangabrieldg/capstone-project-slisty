<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Custom Cake Checkout - Slice N Grind</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/styles/navbar.css" />
    <link rel="stylesheet" href="/styles/footer.css" />
    <style>
      .cake-details {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
      }
      .payment-option {
        border: 2px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
      }
      .payment-option.selected {
        border-color: #2c9045;
        background: #f0fff4;
      }
    </style>
  </head>
  <body>
    <div data-include-html="/public/includes/navbar.html"></div>

    <div class="container py-4">
      <div class="row justify-content-center">
        <div class="col-md-8">
          <div class="card">
            <div class="card-header bg-success text-white">
              <h4 class="mb-0">Custom Cake Checkout</h4>
            </div>
            <div class="card-body">
              <div id="checkoutContent">
                <div class="text-center">
                  <div class="spinner-border text-success" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                  <p class="mt-2">Loading order details...</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div data-include-html="/public/includes/footer.html"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/scripts/include-html.js"></script>
    <script>
      class CustomCakeCheckout {
        constructor() {
          this.orderData = null;
          this.init();
        }

        async init() {
          await this.loadOrderData();
          this.renderCheckout();
        }

        async loadOrderData() {
          const urlParams = new URLSearchParams(window.location.search);
          const orderId = urlParams.get("orderId");
          const orderType = urlParams.get("type");

          if (!orderId || !orderType) {
            this.showError("Invalid checkout link");
            return;
          }

          try {
            const token = localStorage.getItem("token");
            const endpoint =
              orderType === "image"
                ? `/api/custom-cake/image-orders/${orderId}`
                : `/api/custom-cake/${orderId}`;

            const response = await fetch(endpoint, {
              headers: { Authorization: `Bearer ${token}` },
            });

            if (!response.ok) throw new Error("Failed to load order");

            const data = await response.json();
            if (!data.success) throw new Error(data.message);

            this.orderData = {
              ...data.order,
              orderType: orderType,
              displayId:
                orderType === "image"
                  ? `RCC${String(data.order.id).padStart(3, "0")}`
                  : `CC${String(data.order.customCakeId).padStart(3, "0")}`,
            };
          } catch (error) {
            console.error("Error loading order:", error);
            this.showError("Failed to load order data");
          }
        }

        renderCheckout() {
          const container = document.getElementById("checkoutContent");
          if (!container || !this.orderData) return;

          container.innerHTML = `
                    <div class="cake-details mb-4">
                        <h5>Order Details</h5>
                        <p><strong>Order ID:</strong> ${
                          this.orderData.displayId
                        }</p>
                        <p><strong>Type:</strong> ${
                          this.orderData.orderType === "image"
                            ? "Image-Based Cake"
                            : "3D Custom Cake"
                        }</p>
                        <p><strong>Price:</strong> â‚±${parseFloat(
                          this.orderData.price
                        ).toFixed(2)}</p>
                        <p><strong>Status:</strong> <span class="badge bg-success">${
                          this.orderData.status
                        }</span></p>
                    </div>

                    <div class="mb-4">
                        <h5>Select Payment Method</h5>
                        <div class="payment-option" onclick="customCheckout.selectPayment('cash')">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="cashPayment">
                                <label class="form-check-label" for="cashPayment">
                                    <i class="fas fa-money-bill-wave"></i> Cash on Pickup
                                </label>
                            </div>
                            <small class="text-muted">Pay when you pick up your cake at the store</small>
                        </div>
                        
                        <div class="payment-option" onclick="customCheckout.selectPayment('gcash')">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="gcashPayment" checked>
                                <label class="form-check-label" for="gcashPayment">
                                    <i class="fas fa-mobile-alt"></i> GCash
                                </label>
                            </div>
                            <small class="text-muted">Pay securely online using GCash</small>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Sandbox Mode:</strong> Use test GCash number <strong>9051111111</strong> for successful payment
                    </div>

                    <div class="text-center">
                        <button class="btn btn-success btn-lg" onclick="customCheckout.processPayment()">
                            <i class="fas fa-credit-card"></i> Proceed to Payment
                        </button>
                        <a href="/public/customer/my-custom-orders.html" class="btn btn-secondary ms-2">
                            <i class="fas fa-arrow-left"></i> Back to Orders
                        </a>
                    </div>
                `;

          // Select GCash by default
          this.selectPayment("gcash");
        }

        selectPayment(method) {
          document.querySelectorAll(".payment-option").forEach((opt) => {
            opt.classList.remove("selected");
          });

          const selectedOption = document.querySelector(
            `[onclick="customCheckout.selectPayment('${method}')"]`
          );
          if (selectedOption) {
            selectedOption.classList.add("selected");
          }

          document
            .querySelectorAll('input[name="paymentMethod"]')
            .forEach((radio) => {
              radio.checked = radio.id === `${method}Payment`;
            });
        }

        async processPayment() {
          const paymentMethod = document.querySelector(
            'input[name="paymentMethod"]:checked'
          ).value;
          const token = localStorage.getItem("token");

          try {
            if (paymentMethod === "gcash") {
              // Process GCash payment
              const successUrl = `${window.location.origin}/public/customer/success.html`;
              const failedUrl = `${window.location.origin}/public/customer/failed.html`;

              const response = await fetch(
                "/api/payment/create-custom-cake-payment",
                {
                  method: "POST",
                  headers: {
                    Authorization: `Bearer ${token}`,
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify({
                    customCakeId:
                      this.orderData.orderType === "image"
                        ? this.orderData.id
                        : this.orderData.customCakeId,
                    isImageOrder: this.orderData.orderType === "image",
                    amount: this.orderData.price * 100,
                    description: `Custom Cake - ${this.orderData.displayId}`,
                    redirect: {
                      success: successUrl,
                      failed: failedUrl,
                    },
                  }),
                }
              );

              const data = await response.json();
              if (!response.ok) throw new Error(data.error);

              // Open GCash payment window
              window.open(
                data.checkoutUrl,
                "GCashPayment",
                "width=500,height=800"
              );
            } else if (paymentMethod === "cash") {
              // Process cash payment
              const response = await fetch(
                "/api/payment/process-cash-custom-cake",
                {
                  method: "POST",
                  headers: {
                    Authorization: `Bearer ${token}`,
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify({
                    customCakeId:
                      this.orderData.orderType === "image"
                        ? this.orderData.id
                        : this.orderData.customCakeId,
                    isImageOrder: this.orderData.orderType === "image",
                  }),
                }
              );

              const data = await response.json();
              if (!response.ok) throw new Error(data.error);

              alert(
                "Your custom cake order has been confirmed! Please proceed to store pickup with your order ID."
              );
              window.location.href = "/public/customer/success.html";
            }
          } catch (error) {
            console.error("Payment processing failed:", error);
            alert(`Payment failed: ${error.message}`);
          }
        }

        showError(message) {
          const container = document.getElementById("checkoutContent");
          container.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i> ${message}
                    </div>
                    <div class="text-center">
                        <a href="/public/customer/my-custom-orders.html" class="btn btn-primary">
                            Back to Orders
                        </a>
                    </div>
                `;
        }
      }

      // Initialize checkout
      const customCheckout = new CustomCakeCheckout();
    </script>
  </body>
</html>

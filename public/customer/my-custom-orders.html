<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Custom Cake Orders - Slice N Grind</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=Baloo+2:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/styles/navbar.css" />
    <link rel="stylesheet" href="/styles/footer.css" />
    <link rel="stylesheet" href="/styles/my-custom-orders.css" />
  </head>
  <body>
    <!-- Navbar -->
    <div data-include-html="/includes/navbar.html"></div>

    <!-- Main Content -->
    <div class="container-main">
      <h2 class="page-title">My Custom Cake Orders</h2>

      <div class="table-container">
        <div class="table-responsive">
          <table class="table table-hover">
            <div class="d-flex justify-content-between mb-3">
              <h5>Total Orders: <span id="orderCount">0</span></h5>
            </div>
            <thead>
              <tr>
                <th>Order ID</th>
                <th>Type</th>
                <th>Details</th>
                <th>Delivery Date</th>
                <th>Status</th>
                <th>Image</th>
                <th>Price</th>
                <th>Payment</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="ordersTableBody">
              <!-- Orders will be populated dynamically -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Image Modal -->
    <div
      class="modal fade"
      id="imageModal"
      tabindex="-1"
      aria-labelledby="imageModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="imageModalLabel">Custom Cake Image</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <img
              src=""
              class="modal-img"
              id="modalImage"
              alt="Custom Cake Image"
            />
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div data-include-html="/includes/footer.html"></div>

    <script src="/scripts/include-html.js"></script>
    <script src="/scripts/update-navbar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/scripts/custom-cake.js"></script>
    <script>
      const apiService = new CakeAPIService();

      // Fetch and display ALL custom cake orders
      async function fetchCustomOrders() {
        try {
          const response = await apiService.getCustomOrders();
          if (response.success) {
            populateOrdersTable(
              response.data.customOrders,
              response.data.imageOrders
            );
            document.getElementById("orderCount").textContent =
              response.data.customOrders.length +
              response.data.imageOrders.length;
          } else {
            alert(
              response.message || "Failed to load orders. Please try again."
            );
          }
        } catch (error) {
          console.error("Error fetching orders:", error);
          alert("Failed to load orders. Please try again.");
        }
      }

      // Populate table with ALL orders
      function populateOrdersTable(customOrders, imageOrders) {
        const tableBody = document.getElementById("ordersTableBody");
        tableBody.innerHTML = "";

        console.log("Displaying orders:", {
          customOrders: customOrders.length,
          imageOrders: imageOrders.length,
        });

        // Custom Cake Orders (3D) - ALL STATUSES
        customOrders.forEach((order) => {
          const displayOrderId = `CC${String(order.customCakeId).padStart(
            3,
            "0"
          )}`;
          const statusClass = getStatusClass(order.status, false);
          const details = `Flavor: ${order.flavor}, Size: ${
            order.size || "Not specified"
          }, Event: ${new Date(order.eventDate).toLocaleDateString()}`;
          const imageUrl =
            order.designImageUrl || order.referenceImageUrl || "";
          const deliveryDate = order.deliveryDate
            ? new Date(order.deliveryDate).toLocaleDateString()
            : "Not set";

          const paymentMethod =
            order.payment_status === "paid"
              ? "GCash"
              : order.payment_status === "pending"
              ? "Cash"
              : "Not set";
          const paymentStatus = order.payment_status || "pending";
          const paymentBadge =
            paymentStatus === "paid"
              ? '<span class="badge bg-success ms-2">Paid</span>'
              : '<span class="badge bg-warning text-dark ms-2">Pending</span>';

          const row = document.createElement("tr");
          row.innerHTML = `
        <td><span class="order-id">${displayOrderId}</span></td>
        <td><span class="order-type-badge order-type-3d">3D Custom Cake</span></td>
        <td><div class="order-details">${details}</div></td>
        <td><span class="delivery-date">${deliveryDate}</span></td>
        <td><span class="${statusClass}">${order.status}</span></td>
        <td>
          ${
            imageUrl
              ? `<button class="btn btn-view-image" onclick="viewImage('${imageUrl}')">View Image</button>`
              : '<span class="no-image-text">No Image</span>'
          }
        </td>
        <td>${
          order.price
            ? `<span class="price">â‚±${parseFloat(order.price).toFixed(
                2
              )}</span>`
            : '<span class="price-tbd">TBD</span>'
        }</td>
        <td>
          <div>${paymentMethod}${paymentBadge}</div>
        </td>
        <td>${getActionButtons(order, false)}</td>
      `;
          tableBody.appendChild(row);
        });

        // Image-Based Orders - ALL STATUSES
        imageOrders.forEach((order) => {
          const displayOrderId = `RCC${String(order.imageBasedOrderId).padStart(
            3,
            "0"
          )}`;
          const statusClass = getStatusClass(order.status, true);
          const details = `Flavor: ${order.flavor}, Event: ${new Date(
            order.eventDate
          ).toLocaleDateString()}`;
          const deliveryDate = order.deliveryDate
            ? new Date(order.deliveryDate).toLocaleDateString()
            : "Not set";

          const paymentMethod =
            order.payment_status === "paid"
              ? "GCash"
              : order.payment_status === "pending"
              ? "Cash"
              : "Not set";
          const paymentStatus = order.payment_status || "pending";
          const paymentBadge =
            paymentStatus === "paid"
              ? '<span class="badge bg-success ms-2">Paid</span>'
              : '<span class="badge bg-warning text-dark ms-2">Pending</span>';

          const row = document.createElement("tr");
          row.innerHTML = `
        <td><span class="order-id">${displayOrderId}</span></td>
        <td><span class="order-type-badge order-type-image">Image-Based Cake</span></td>
        <td><div class="order-details">${details}</div></td>
        <td><span class="delivery-date">${deliveryDate}</span></td>
        <td><span class="${statusClass}">${order.status}</span></td>
        <td>${
          order.imagePath
            ? `<button class="btn btn-view-image" onclick="viewImage('${order.imagePath}')">View Image</button>`
            : '<span class="no-image-text">No Image</span>'
        }</td>
        <td>${
          order.price
            ? `<span class="price">â‚±${parseFloat(order.price).toFixed(
                2
              )}</span>`
            : '<span class="price-tbd">TBD</span>'
        }</td>
        <td>
          <div>${paymentMethod}${paymentBadge}</div>
        </td>
        <td>${getActionButtons(order, true)}</td>
      `;
          tableBody.appendChild(row);
        });

        // Show empty state if no orders
        if (customOrders.length === 0 && imageOrders.length === 0) {
          const row = document.createElement("tr");
          row.innerHTML = `
        <td colspan="9" class="text-center py-4">
          <div class="empty-state">
            <div class="icon">ðŸŽ‚</div>
            <h4>No Custom Orders Yet</h4>
            <p>Start by creating a custom cake order!</p>
          </div>
        </td>
      `;
          tableBody.appendChild(row);
        }
      }

      // Helper function to get flavor name
      function getFlavorName(cakeColor) {
        const flavors = {
          "#8B4513": "Chocolate",
          "#FFFFFF": "White",
          "#FFD700": "Vanilla",
          "#FF69B4": "Strawberry",
        };
        return flavors[cakeColor] || "Custom";
      }

      // Get status class based on status type
      function getStatusClass(status, isImageOrder) {
        if (isImageOrder) {
          switch (status) {
            case "Feasible":
            case "Ready":
              return "status-feasible";
            case "In Progress":
            case "Ready for Pickup/Delivery":
            case "Completed":
              return "status-completed";
            case "Not Feasible":
            case "Cancelled":
              return "status-not-feasible";
            default:
              return "status-pending";
          }
        } else {
          switch (status) {
            case "Ready":
            case "In Progress":
              return "status-feasible";
            case "Ready for Pickup/Delivery":
            case "Completed":
              return "status-completed";
            case "Cancelled":
              return "status-not-feasible";
            default:
              return "status-pending";
          }
        }
      }

      // Get action buttons based on order status - SHOW FOR ALL ORDERS
      // In my-custom-orders.html - UPDATE the getActionButtons function:
      function getActionButtons(order, isImageOrder) {
        const orderId = isImageOrder
          ? order.imageBasedOrderId
          : order.customCakeId;

        if (isImageOrder) {
          // Image-based order actions - ONLY show checkout for Feasible orders with price
          if (order.status === "Not Feasible" || order.status === "Cancelled") {
            return `<span class="text-muted">Order ${order.status}</span>`;
          } else if (
            order.status === "Feasible" &&
            order.price &&
            order.payment_status === "pending"
          ) {
            // ONLY show checkout button for Feasible orders that haven't been paid yet
            return `
        <button class="btn btn-checkout" onclick="checkoutOrder(${orderId}, true)">
          Checkout Now
        </button>
      `;
          } else if (order.payment_status === "paid") {
            return `<span class="badge bg-success">Paid</span>`;
          } else if (
            order.payment_status === "pending" &&
            [
              "Pending",
              "In Progress",
              "Ready",
              "Ready for Pickup/Delivery",
              "Completed",
            ].includes(order.status)
          ) {
            return `<span class="badge bg-warning">Cash - Pending Payment</span>`;
          } else {
            return `<span class="text-info">${order.status}</span>`;
          }
        } else {
          // 3D custom cake actions - NEVER show checkout button (they already checked out)
          if (order.payment_status === "paid") {
            return `<span class="badge bg-success">Paid</span>`;
          } else if (
            order.payment_status === "pending" &&
            [
              "Pending",
              "In Progress",
              "Ready",
              "Ready for Pickup/Delivery",
              "Completed",
            ].includes(order.status)
          ) {
            return `<span class="badge bg-warning">Cash - Pending Payment</span>`;
          } else if (order.status === "Cancelled") {
            return `<span class="text-muted">Cancelled</span>`;
          } else {
            return `<span class="text-info">${order.status}</span>`;
          }
        }
      }

      async function checkoutOrder(orderId, isImageOrder) {
        const orderDetails = await apiService.getOrderDetails(
          orderId,
          isImageOrder
        );
        if (!orderDetails.success) {
          throw new Error("Could not retrieve order details");
        }

        const order = orderDetails.data.order;
        const amount = order.price;

        window.location.href = `/public/customer/checkout.html?customCakeId=${orderId}&isImageOrder=${isImageOrder}&amount=${amount}`;
      }

      // View image in modal
      function viewImage(imageUrl) {
        const modalImage = document.getElementById("modalImage");
        modalImage.src = imageUrl;
        const modal = new bootstrap.Modal(
          document.getElementById("imageModal")
        );
        modal.show();
      }

      // Load ALL orders on page load
      document.addEventListener("DOMContentLoaded", fetchCustomOrders);
    </script>
  </body>
</html>
